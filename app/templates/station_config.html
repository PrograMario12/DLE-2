{% extends 'base/base_dashboards.html' %} {% block title %} Configuraci√≥n de
Estaci√≥n {% endblock %} {% block styles %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/ajustes_styles.css') }}"
/>
<style>
  /* Local Overrides for Config Layout */
  .config-layout {
    display: flex;
    height: calc(100vh - 100px); /* Adjust based on header */
    gap: 2rem;
    padding: 2rem;
  }

  /* Sidebar */
  .config-sidebar {
    width: 300px;
    background-color: var(--color-white);
    border: var(--border-thick);
    box-shadow: var(--shadow-industrial);
    display: flex;
    flex-direction: column;
  }

  .sidebar-header {
    background-color: var(--color-black);
    color: var(--color-white);
    padding: 1.5rem;
    font-size: 1.6rem;
    font-weight: 800;
    text-transform: uppercase;
    text-align: center;
  }

  .sidebar-list {
    flex: 1;
    overflow-y: auto;
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .sidebar-item {
    padding: 1.5rem;
    border-bottom: 1px solid #ddd;
    font-size: 1.4rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .sidebar-item:hover {
    background-color: #f0f0f0;
  }

  .sidebar-item.active {
    background-color: var(--color-accent);
    color: white;
  }

  /* Main Content */
  .config-main {
    flex: 1;
    background-color: var(--color-bg-light);
    border: var(--border-thick);
    box-shadow: var(--shadow-industrial);
    display: flex;
    flex-direction: column;
    padding: 2rem;
    overflow-y: auto;
  }

  .main-header {
    border-bottom: 2px solid var(--color-black);
    padding-bottom: 1rem;
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .breadcrumb {
    font-size: 1.8rem;
    font-weight: 800;
    text-transform: uppercase;
    color: var(--color-gray);
  }

  .breadcrumb span.current {
    color: var(--color-black);
    text-decoration: underline;
    text-decoration-color: var(--color-primary);
  }

  .grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 2rem;
  }

  /* Config Card */
  .config-card {
    background-color: var(--color-white);
    border: var(--border-thick);
    padding: 2rem;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    min-height: 150px;
    box-shadow: var(--shadow-industrial);
    transition: transform 0.1s;
    cursor: pointer;
  }

  .config-card:hover {
    transform: translate(2px, 2px);
    box-shadow: 2px 2px 0px #000;
  }

  .card-title {
    font-size: 1.6rem;
    font-weight: 800;
    margin-bottom: 1rem;
    text-transform: uppercase;
  }

  .card-subtitle {
    font-size: 1.2rem;
    color: #666;
  }

  .card-actions {
    margin-top: auto;
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
  }

  .btn-icon {
    width: 32px;
    height: 32px;
    border: 2px solid #000;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    cursor: pointer;
  }

  .btn-icon:hover {
    background-color: var(--color-accent);
    color: white;
  }

  .add-card {
    border: 2px dashed #888;
    background-color: transparent;
    box-shadow: none;
    align-items: center;
    justify-content: center;
    color: #666;
  }

  .add-card:hover {
    border-color: var(--color-black);
    color: var(--color-black);
    background-color: rgba(0, 0, 0, 0.05);
  }

  .add-icon {
    font-size: 4rem;
    font-weight: 100;
  }
</style>
{% endblock %} {% block header %}
<h1>Configuraci√≥n de Estaci√≥n</h1>
<div style="font-size: 1.2rem; margin-top: 0.5rem; color: #555">
  Administraci√≥n de jerarqu√≠a operativa
</div>
{% endblock %} {% block content %}
<div class="config-layout">
  <!-- Left: Sidebar (Areas) -->
  <aside class="config-sidebar">
    <div class="sidebar-header">√Åreas</div>
    <ul class="sidebar-list" id="areaList">
      <!-- Populated by JS -->
      <li class="sidebar-item" style="justify-content: center">Cargando...</li>
    </ul>
    <div
      class="sidebar-item add-area-btn"
      id="btnAddArea"
      style="justify-content: center; background: #eee; font-weight: 800"
    >
      + NUEVA √ÅREA
    </div>
  </aside>

  <!-- Right: Main Content (Lines -> Stations -> Positions) -->
  <main class="config-main">
    <div class="main-header">
      <div class="breadcrumb" id="breadcrumb">
        <!-- Populated by JS e.g. INYECCI√ìN > L√çNEAS -->
        Selecciona un √°rea
      </div>
    </div>

    <div class="grid-container" id="contentGrid">
      <!-- Tiles go here -->
      <div
        style="
          grid-column: 1/-1;
          text-align: center;
          color: #888;
          font-size: 1.4rem;
          margin-top: 5rem;
        "
      >
        üëà Selecciona un √°rea para comenzar la configuraci√≥n.
      </div>
    </div>
  </main>
</div>

<!-- Config Modal (Generic for Add/Edit) -->
<div id="modalConfig" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header" id="modalConfigTitle">NUEVO ITEM</div>
    <div class="modal-body">
      <input type="hidden" id="configItemId" />
      <input type="hidden" id="configItemType" />
      <input type="hidden" id="configParentId" />

      <label
        class="warning-text"
        style="text-align: left; color: #000; margin-bottom: 0.5rem"
        >Nombre:</label
      >
      <input
        type="text"
        id="configItemName"
        class="modal-select"
        placeholder="Ej. L√≠nea 1"
      />

      <!-- Conditional Inputs -->
      <div id="extraInputs" style="margin-top: 1rem"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-modal btn-cancel" id="btnConfigCancel">
        Cancelar
      </button>
      <button class="btn-modal btn-confirm" id="btnConfigSave">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Delete Confirmation (Generic) -->
<div id="modalConfirmDelete" class="modal-overlay">
  <div class="modal-content" style="border-color: var(--color-primary)">
    <div class="modal-header" style="background-color: var(--color-primary)">
      ‚ö†Ô∏è CONFIRMAR ELIMINACI√ìN
    </div>
    <div class="modal-body">
      <p>Est√°s a punto de eliminar:</p>
      <h2 id="deleteTargetName" style="margin: 1rem 0; font-size: 2rem">
        ITEM
      </h2>
      <span class="warning-text">
        Esta acci√≥n es irreversible y podr√≠a afectar datos hist√≥ricos.
      </span>
    </div>
    <div class="modal-footer">
      <button class="btn-modal btn-cancel" id="btnCancelDelete">
        Cancelar
      </button>
      <button class="btn-modal btn-danger" id="btnConfirmDelete">
        ELIMINAR
      </button>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // State
    let hierarchyData = {};
    let currentArea = null;
    let currentLine = null;
    let currentStation = null;
    let currentLevel = "areas"; // areas, lines, stations, sides

    const areaList = document.getElementById("areaList");
    const contentGrid = document.getElementById("contentGrid");
    const breadcrumb = document.getElementById("breadcrumb");

    // Config Modal Elements
    const modalConfig = document.getElementById("modalConfig");
    const modalTitle = document.getElementById("modalConfigTitle");
    const itemName = document.getElementById("configItemName");
    const btnSave = document.getElementById("btnConfigSave");
    const btnCancel = document.getElementById("btnConfigCancel");

    // Delete Modal Elements
    const modalDelete = document.getElementById("modalConfirmDelete");
    const deleteTargetName = document.getElementById("deleteTargetName");
    const btnCancelDelete = document.getElementById("btnCancelDelete");
    const btnConfirmDelete = document.getElementById("btnConfirmDelete");

    let deleteCallback = null; // Function to execute on confirm

    // Initial Load
    fetchHierarchy();

    function fetchHierarchy() {
      fetch("{{ url_for('settings.get_hierarchy') }}")
        .then((r) => r.json())
        .then((data) => {
          hierarchyData = data.hierarchy;
          renderAreas();
        })
        .catch((err) => {
          areaList.innerHTML =
            '<li class="sidebar-item" style="color:red">Error cargando datos</li>';
          console.error(err);
        });
    }

    function renderAreas() {
      areaList.innerHTML = "";
      Object.keys(hierarchyData).forEach((area) => {
        const li = document.createElement("li");
        li.className = "sidebar-item";
        li.textContent = area;
        li.onclick = () => selectArea(area, li);
        areaList.appendChild(li);
      });
    }

    // Make visible to global scope for breadcrumbs
    window.selectArea = (areaName, liElement) => {
      currentArea = areaName;
      currentLine = null;
      currentStation = null;
      currentLevel = "lines";

      // Highlight logic
      document
        .querySelectorAll(".sidebar-item")
        .forEach((el) => el.classList.remove("active"));
      if (liElement) liElement.classList.add("active");
      else {
        // Find by text if not passed directly
        const items = document.querySelectorAll(".sidebar-item");
        for (let i of items)
          if (i.textContent === areaName) i.classList.add("active");
      }

      updateBreadcrumb();
      renderLines(areaName);
    };

    function renderLines(areaName) {
      contentGrid.innerHTML = "";
      const lines = hierarchyData[areaName] || [];

      lines.forEach((line) => {
        const card = createCard(line.name, "L√≠nea de Producci√≥n", () =>
          selectLine(line)
        );
        contentGrid.appendChild(card);
      });

      // Add New Line Button
      const addCard = createAddCard("Nueva L√≠nea", () => openModal("add_line"));
      contentGrid.appendChild(addCard);
    }

    window.selectLine = (lineObj) => {
      currentLine = lineObj;
      currentStation = null;
      currentLevel = "stations";
      updateBreadcrumb();
      renderStations(lineObj);
    };

    function renderStations(lineObj) {
      contentGrid.innerHTML =
        '<div style="grid-column: 1/-1; text-align: center; padding: 2rem; font-size:1.4rem;">Cargando estaciones...</div>';

      fetch(
        `{{ url_for('settings.get_line_stations', line_id=0) }}`.replace(
          "0",
          lineObj.line_id
        )
      )
        .then((r) => r.json())
        .then((data) => {
          contentGrid.innerHTML = "";
          const stations = data.stations || [];

          if (stations.length === 0) {
            contentGrid.innerHTML =
              '<div style="grid-column: 1/-1; text-align: center; color: #888; font-size: 1.4rem; margin-top: 2rem;">No hay estaciones configuradas.</div>';
          }

          stations.forEach((st) => {
            // Calculate total capacity
            let totalCap = 0;
            if (st.sides && st.sides.length > 0) {
              totalCap = st.sides.reduce(
                (acc, side) => acc + (side.employee_capacity || 0),
                0
              );
            }

            const card = createConfigurableCard(
              st.position_name,
              `Capacidad: ${totalCap} pers.`,
              () => selectStation(st), // Main click
              () => openModal("edit_station", st), // Edit click
              () => confirmDelete("station", st.position_name, st.position_id) // Delete click
            );
            contentGrid.appendChild(card);
          });

          const addCard = createAddCard("Nueva Estaci√≥n", () =>
            openModal("add_station")
          );
          contentGrid.appendChild(addCard);
        })
        .catch((err) => {
          console.error(err);
          contentGrid.innerHTML =
            '<div style="grid-column: 1/-1; text-align: center; color: red; font-size: 1.4rem;">Error al cargar estaciones.</div>';
        });
    }

    function selectStation(stationObj) {
      currentStation = stationObj;
      currentLevel = "sides";
      updateBreadcrumb();
      renderSides(stationObj);
    }

    function renderSides(stationObj) {
      contentGrid.innerHTML = "";
      const sides = stationObj.sides || [];

      sides.forEach((side) => {
        const card = createConfigurableCard(
          side.side_title,
          `Capacidad: ${side.employee_capacity}`,
          null, // No further drill-down
          () => openModal("edit_side", side), // Edit click
          () => confirmDelete("side", side.side_title, side.side_id) // Delete click
        );
        // Disable main click visual if null
        if (!currentStation) card.onclick = null;

        contentGrid.appendChild(card);
      });

      const addCard = createAddCard("Nuevo Side", () => openModal("add_side"));
      contentGrid.appendChild(addCard);
    }

    // --- Delete Logic ---
    function confirmDelete(type, name, id) {
      modalDelete.style.display = "flex";
      deleteTargetName.textContent = type.toUpperCase() + ": " + name;

      btnConfirmDelete.onclick = () => {
        btnConfirmDelete.disabled = true;
        btnConfirmDelete.textContent = "Eliminando...";
        let url = "";

        if (type === "side")
          url = `{{ url_for('settings.delete_side', side_id=0) }}`.replace(
            "0",
            id
          );
        if (type === "station")
          url =
            `{{ url_for('settings.delete_position', position_id=0) }}`.replace(
              "0",
              id
            );

        fetch(url, { method: "DELETE" })
          .then((r) => r.json())
          .then((d) => {
            modalDelete.style.display = "none";
            btnConfirmDelete.disabled = false;
            btnConfirmDelete.textContent = "ELIMINAR";

            if (d.success) {
              if (type === "side") refreshStations();
              if (type === "station") selectLine(currentLine); // Refresh station list
            } else {
              alert("Error: " + d.message);
            }
          })
          .catch((err) => {
            console.error(err);
            alert("Error de red");
            modalDelete.style.display = "none";
            btnConfirmDelete.disabled = false;
            btnConfirmDelete.textContent = "ELIMINAR";
          });
      };
    }

    btnCancelDelete.onclick = () => {
      modalDelete.style.display = "none";
    };

    function refreshStations() {
      // Reload current line stations to refresh view
      if (currentLevel === "sides" && currentLine) {
        // Need to re-fetch line stations first to get updated data
        fetch(
          `{{ url_for('settings.get_line_stations', line_id=0) }}`.replace(
            "0",
            currentLine.line_id
          )
        )
          .then((r) => r.json())
          .then((data) => {
            const updatedStations = data.stations || [];
            const updatedStation = updatedStations.find(
              (s) => s.position_id === currentStation.position_id
            );
            if (updatedStation) {
              selectStation(updatedStation); // Re-render sides
            } else {
              // Fallback if station gone?
              selectLine(currentLine);
            }
          });
      }
    }

    function updateBreadcrumb() {
      if (!currentArea) {
        breadcrumb.innerHTML = "Selecciona un √°rea";
        return;
      }

      let html = `<span style="cursor:pointer" onclick="resetView()">AREAS</span> > `;
      html += `<span style="cursor:pointer" onclick="selectArea('${currentArea}', null)">${currentArea}</span>`;

      if (currentLine) {
        html += ` > <span style="cursor:pointer" onclick="selectLine({line_id:${currentLine.line_id}, name:'${currentLine.name}'})">${currentLine.name}</span>`;
      }

      if (currentLevel === "sides" && currentStation) {
        html += ` > <span class="current">Estaci√≥n ${currentStation.position_name}</span>`;
      }

      breadcrumb.innerHTML = html;
    }

    // UI Helpers
    function createCard(title, subtitle, onClick) {
      // Simple card without strict actions (Used for Areas/Lines currently)
      const div = document.createElement("div");
      div.className = "config-card";
      div.innerHTML = `
            <div>
                <div class="card-title">${title}</div>
                <div class="card-subtitle">${subtitle}</div>
            </div>
            <div class="card-actions">
                <!-- Actions not implemented for Areas/Lines yet -->
            </div>
        `;
      div.onclick = (e) => {
        if (!e.target.classList.contains("btn-icon")) {
          onClick();
        }
      };
      return div;
    }

    function createConfigurableCard(
      title,
      subtitle,
      onMainClick,
      onEdit,
      onDelete
    ) {
      const div = document.createElement("div");
      div.className = "config-card";

      // Prevent click if no main action (e.g. side drilldown ends)
      const cursorStyle = onMainClick ? "cursor: pointer;" : "cursor: default;";
      div.style.cssText = cursorStyle;

      div.innerHTML = `
            <div>
                <div class="card-title">${title}</div>
                <div class="card-subtitle">${subtitle}</div>
            </div>
            <div class="card-actions">
                <div class="btn-icon btn-edit">‚úèÔ∏è</div>
                <div class="btn-icon btn-delete">üóëÔ∏è</div>
            </div>
        `;

      // Attach listeners safely
      const btnEdit = div.querySelector(".btn-edit");
      const btnDelete = div.querySelector(".btn-delete");

      btnEdit.onclick = (e) => {
        e.stopPropagation();
        onEdit();
      };
      btnDelete.onclick = (e) => {
        e.stopPropagation();
        onDelete();
      };

      if (onMainClick) {
        div.onclick = (e) => {
          // Ignore clicks on buttons (already handled by stopPropagation, but extra safety)
          if (!e.target.classList.contains("btn-icon")) {
            onMainClick();
          }
        };
      }

      return div;
    }

    function createAddCard(label, onClick) {
      const div = document.createElement("div");
      div.className = "config-card add-card";
      div.innerHTML = `
            <div class="add-icon">+</div>
            <div style="font-weight:700; margin-top:1rem;">${label}</div>
        `;
      div.onclick = onClick;
      return div;
    }

    let editingSideId = null;
    let editingStationId = null;

    function openModal(mode, data = null) {
      modalConfig.style.display = "flex";
      itemName.value = "";
      const extraInputs = document.getElementById("extraInputs");
      extraInputs.innerHTML = "";

      editingSideId = null;
      editingStationId = null;

      if (mode === "add_line")
        modalTitle.textContent = "NUEVA L√çNEA EN " + currentArea;

      if (mode === "add_station") {
        modalTitle.textContent = "NUEVA ESTACI√ìN EN " + currentLine.name;
        itemName.placeholder = "Nombre (Ej. 30, Estaci√≥n B)";
        document.getElementById("configItemType").value = "station_create"; // To implement
      }

      if (mode === "edit_station") {
        modalTitle.textContent = "EDITAR ESTACI√ìN";
        itemName.value = data.position_name;
        editingStationId = data.position_id;
        document.getElementById("configItemType").value = "station_update";
      }

      if (mode === "add_side") {
        modalTitle.textContent =
          "NUEVO SIDE EN " + currentStation.position_name;
        itemName.style.display = "none"; // Hide the regular name input
        extraInputs.innerHTML = `
                 <label class="warning-text" style="color:black; margin-bottom:0.5rem;">Tipo de Side:</label>
                 <select id="configSideType" class="modal-select">
                   <option value="">-- Selecciona un tipo --</option>
                   <option value="BP">BP</option>
                   <option value="LH">LH</option>
                   <option value="RH">RH</option>
                 </select>
                 <label class="warning-text" style="color:black; margin-top:1rem;">Personal Requerido:</label>
                 <input type="number" id="configCapacity" class="modal-select" value="1" min="1">
             `;
        document.getElementById("configItemType").value = "side_create";
      }

      if (mode === "edit_side") {
        modalTitle.textContent = "EDITAR SIDE " + data.side_title;
        itemName.style.display = "none"; // Hide for edit too
        extraInputs.innerHTML = `
                 <label class="warning-text" style="color:black; margin-bottom:0.5rem;">Tipo de Side:</label>
                 <select id="configSideType" class="modal-select">
                   <option value="BP" ${
                     data.side_title === "BP" ? "selected" : ""
                   }>BP</option>
                   <option value="LH" ${
                     data.side_title === "LH" ? "selected" : ""
                   }>LH</option>
                   <option value="RH" ${
                     data.side_title === "RH" ? "selected" : ""
                   }>RH</option>
                 </select>
                 <label class="warning-text" style="color:black; margin-top:1rem;">Personal Requerido:</label>
                 <input type="number" id="configCapacity" class="modal-select" value="${
                   data.employee_capacity
                 }" min="1">
             `;
        editingSideId = data.side_id;
        document.getElementById("configItemType").value = "side_update";
      }
    }

    btnCancel.onclick = () => (modalConfig.style.display = "none");

    btnSave.onclick = () => {
      const type = document.getElementById("configItemType").value;
      const nameVal = itemName.value;

      if (type === "side_create") {
        const sideType = document.getElementById("configSideType").value;
        const cap = document.getElementById("configCapacity").value;

        if (!sideType) {
          alert("Por favor selecciona un tipo de side");
          return;
        }

        fetch("{{ url_for('settings.create_side') }}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            position_id: currentStation.position_id,
            title: sideType,
            capacity: cap,
          }),
        })
          .then((r) => r.json())
          .then((d) => {
            if (d.success) {
              modalConfig.style.display = "none";
              refreshStations();
            } else alert(d.message);
          });
      } else if (type === "side_update") {
        const sideType = document.getElementById("configSideType").value;
        const cap = document.getElementById("configCapacity").value;
        fetch(
          `{{ url_for('settings.update_side', side_id=0) }}`.replace(
            "0",
            editingSideId
          ),
          {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              title: sideType,
              capacity: cap,
            }),
          }
        )
          .then((r) => r.json())
          .then((d) => {
            if (d.success) {
              modalConfig.style.display = "none";
              refreshStations();
            } else alert(d.message);
          });
      } else if (type === "station_create") {
        fetch("{{ url_for('settings.create_position') }}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            line_id: currentLine.line_id,
            position_name: nameVal,
          }),
        })
          .then((r) => r.json())
          .then((d) => {
            if (d.success) {
              modalConfig.style.display = "none";
              selectLine(currentLine);
            } else alert(d.message);
          });
      } else if (type === "station_update") {
        fetch(
          `{{ url_for('settings.update_position', position_id=0) }}`.replace(
            "0",
            editingStationId
          ),
          {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              position_name: nameVal,
            }),
          }
        )
          .then((r) => r.json())
          .then((d) => {
            if (d.success) {
              modalConfig.style.display = "none";
              selectLine(currentLine); // Refresh station list
            } else alert(d.message);
          });
      } else {
        alert("Guardado simulado para este tipo de item.");
        modalConfig.style.display = "none";
      }
    };

    window.resetView = () => {
      currentLine = null;
      currentStation = null;
      currentLevel = "areas";
      renderAreas();
      contentGrid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: #888; font-size: 1.4rem; margin-top: 5rem;">üëà Selecciona un √°rea</div>`;
      breadcrumb.innerHTML = "Selecciona un √°rea";
      document
        .querySelectorAll(".sidebar-item")
        .forEach((el) => el.classList.remove("active"));
    };
  });
</script>
{% endblock %}
